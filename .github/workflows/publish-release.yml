name: Publish Release

on:
  workflow_call:
    secrets:
      NPM_TOKEN:
        required: true
      SLACK_WEBHOOK_URL:
        required: true
      PUBLISH_DOCS_TOKEN:
        required: true

jobs:
  publish-release:
    permissions:
      contents: write
    runs-on: ubuntu-latest
    steps:
      - name: Checkout and setup environment
        uses: MetaMask/action-checkout-and-setup@v1
        with:
          is-high-risk-environment: true
      - uses: MetaMask/action-publish-release@v3
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - run: yarn build
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: publish-release-artifacts-${{ github.sha }}
          include-hidden-files: true
          retention-days: 4
          path: |
            ./packages/**/dist
            ./playground/**/dist
            ./node_modules/.yarn-state.yml

  publish-npm-dry-run:
    name: Dry run publish to NPM
    runs-on: ubuntu-latest
    needs: publish-release
    steps:
      - name: Checkout and setup environment
        uses: MetaMask/action-checkout-and-setup@v1
        with:
          is-high-risk-environment: true
          ref: ${{ github.sha }}
      - name: Restore build artifacts
        uses: actions/download-artifact@v4
        with:
          name: publish-release-artifacts-${{ github.sha }}
      - name: Dry run publish to NPM
        uses: MetaMask/action-npm-publish@v5
        with:
          slack-webhook-url: ${{ secrets.SLACK_WEBHOOK_URL }}
          subteam: S042S7RE4AE # @metamask-npm-publishers

  publish-npm:
    name: Publish to NPM
    environment: npm-publish
    runs-on: ubuntu-latest
    needs: publish-npm-dry-run
    steps:
      - name: Checkout and setup environment
        uses: MetaMask/action-checkout-and-setup@v1
        with:
          is-high-risk-environment: true
          ref: ${{ github.sha }}
      - name: Restore build artifacts
        uses: actions/download-artifact@v4
        with:
          name: publish-release-artifacts-${{ github.sha }}
      - name: Publish to NPM
        uses: MetaMask/action-npm-publish@v5
        with:
          npm-token: ${{ secrets.NPM_TOKEN }}

  get-release-version:
    needs: publish-npm
    runs-on: ubuntu-latest
    outputs:
      RELEASE_VERSION: ${{ steps.get-release-version.outputs.RELEASE_VERSION }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.sha }}
          fetch-depth: 0
      - id: get-release-version
        shell: bash
        run: |
          # Get version from the latest git tag created by the release action
          VERSION=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          if [ -z "$VERSION" ]; then
            # Fallback to package.json version if no tag found
            VERSION=$(node -p "require('./package.json').version")
          fi
          # Remove 'v' prefix if present
          VERSION=${VERSION#v}
          echo "RELEASE_VERSION=$VERSION" >> "$GITHUB_OUTPUT"

  publish-wagmi-to-gh-pages:
    name: Publish Wagmi Integration to `${{ needs.get-release-version.outputs.RELEASE_VERSION }}` directory of `gh-pages` branch
    needs: get-release-version
    permissions:
      contents: write
    uses: ./.github/workflows/deploy-wagmi-to-gh-pages.yml
    with:
      destination_dir: ${{ needs.get-release-version.outputs.RELEASE_VERSION }}
    secrets:
      PUBLISH_DOCS_TOKEN: ${{ secrets.PUBLISH_DOCS_TOKEN }}

  publish-wagmi-to-latest-gh-pages:
    name: Publish Wagmi Integration to `latest` directory of `gh-pages` branch
    needs: publish-wagmi-to-gh-pages
    permissions:
      contents: write
    uses: ./.github/workflows/deploy-wagmi-to-gh-pages.yml
    with:
      destination_dir: latest
    secrets:
      PUBLISH_DOCS_TOKEN: ${{ secrets.PUBLISH_DOCS_TOKEN }}

  publish-browser-playground-to-gh-pages:
    name: Publish Browser Playground to `${{ needs.get-release-version.outputs.RELEASE_VERSION }}` directory of `gh-pages` branch
    needs: get-release-version
    permissions:
      contents: write
    uses: ./.github/workflows/deploy-browser-playground-to-gh-pages.yml
    with:
      destination_dir: ${{ needs.get-release-version.outputs.RELEASE_VERSION }}
    secrets:
      PUBLISH_DOCS_TOKEN: ${{ secrets.PUBLISH_DOCS_TOKEN }}

  publish-browser-playground-to-latest-gh-pages:
    name: Publish Browser Playground to `latest` directory of `gh-pages` branch
    needs: publish-browser-playground-to-gh-pages
    permissions:
      contents: write
    uses: ./.github/workflows/deploy-browser-playground-to-gh-pages.yml
    with:
      destination_dir: latest
    secrets:
      PUBLISH_DOCS_TOKEN: ${{ secrets.PUBLISH_DOCS_TOKEN }}
